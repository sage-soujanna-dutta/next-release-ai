#!/usr/bin/env tsx

/**
 * Generate Mock Sprint Release Notes for SCNT-sprint-21 (2025)
 * Creates professional documentation using template and sends Teams notification
 */

import { MCPToolFactory } from './src/core/MCPToolFactory';
import { readFile, writeFile } from 'fs/promises';
import path from 'path';

async function generateMockSCNTSprint21() {
  console.log('üöÄ Generating Mock Release Notes for Sprint SCNT-sprint-21 (2025)');
  
  try {
    // Generate mock sprint data
    const mockSprintData = {
      sprintId: 'SCNT-sprint-21',
      sprintName: 'SCNT Sprint 21 - Q3 2025 Development Cycle',
      startDate: '2025-07-28',
      endDate: '2025-08-11',
      status: 'Completed',
      completionRate: 96.8,
      totalIssues: 127,
      completedIssues: 123,
      remainingIssues: 4,
      storyPoints: 174,
      teamMembers: 14,
      commitCount: 89,
      pipelineBuilds: 6,
      workBreakdown: {
        stories: { count: 78, percentage: 61.4 },
        bugs: { count: 31, percentage: 24.4 },
        tasks: { count: 12, percentage: 9.4 },
        epics: { count: 4, percentage: 3.1 },
        improvements: { count: 2, percentage: 1.6 }
      },
      priorityDistribution: {
        critical: { count: 5, resolved: 5, percentage: 3.9 },
        high: { count: 42, resolved: 41, percentage: 33.1 },
        medium: { count: 58, resolved: 56, percentage: 45.7 },
        low: { count: 18, resolved: 18, percentage: 14.2 },
        blockers: { count: 4, resolved: 3, percentage: 3.1 }
      }
    };

    // Generate HTML report using professional template
    const htmlReport = await generateProfessionalHTMLReport(mockSprintData);
    
    // Save the report
    const outputDir = 'output';
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
    const fileName = `release-notes-SCNT-sprint-21-2025-${timestamp}.html`;
    const filePath = path.join(outputDir, fileName);
    
    await writeFile(filePath, htmlReport, 'utf8');
    console.log(`üìÑ Professional HTML report generated: ${filePath}`);

    // Send Teams notification with proper design guidelines
    await sendTeamsDesignCompliantNotification(mockSprintData, fileName);

    return {
      sprintData: mockSprintData,
      outputFile: filePath,
      success: true
    };

  } catch (error) {
    console.error('‚ùå Error generating mock sprint release notes:', error);
    throw error;
  }
}

async function generateProfessionalHTMLReport(sprintData: any): Promise<string> {
  console.log('üé® Generating professional HTML report using template...');
  
  try {
    // Read the professional template
    const templatePath = './professional-release-template.html';
    let template = await readFile(templatePath, 'utf8');
    
    // Replace template variables with sprint data
    template = template
      .replace(/{{SPRINT_NAME}}/g, sprintData.sprintName)
      .replace(/{{SPRINT_ID}}/g, sprintData.sprintId)
      .replace(/{{START_DATE}}/g, new Date(sprintData.startDate).toLocaleDateString('en-US', { 
        year: 'numeric', month: 'long', day: 'numeric' 
      }))
      .replace(/{{END_DATE}}/g, new Date(sprintData.endDate).toLocaleDateString('en-US', { 
        year: 'numeric', month: 'long', day: 'numeric' 
      }))
      .replace(/{{COMPLETION_RATE}}/g, sprintData.completionRate.toString())
      .replace(/{{TOTAL_ISSUES}}/g, sprintData.totalIssues.toString())
      .replace(/{{COMPLETED_ISSUES}}/g, sprintData.completedIssues.toString())
      .replace(/{{STORY_POINTS}}/g, sprintData.storyPoints.toString())
      .replace(/{{TEAM_MEMBERS}}/g, sprintData.teamMembers.toString())
      .replace(/{{COMMIT_COUNT}}/g, sprintData.commitCount.toString())
      .replace(/{{PIPELINE_BUILDS}}/g, sprintData.pipelineBuilds.toString())
      .replace(/{{GENERATION_DATE}}/g, new Date().toLocaleDateString('en-US', { 
        year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' 
      }))
      .replace(/{{STORIES_COUNT}}/g, sprintData.workBreakdown.stories.count.toString())
      .replace(/{{STORIES_PERCENTAGE}}/g, sprintData.workBreakdown.stories.percentage.toString())
      .replace(/{{BUGS_COUNT}}/g, sprintData.workBreakdown.bugs.count.toString())
      .replace(/{{BUGS_PERCENTAGE}}/g, sprintData.workBreakdown.bugs.percentage.toString())
      .replace(/{{TASKS_COUNT}}/g, sprintData.workBreakdown.tasks.count.toString())
      .replace(/{{TASKS_PERCENTAGE}}/g, sprintData.workBreakdown.tasks.percentage.toString())
      .replace(/{{CRITICAL_COUNT}}/g, sprintData.priorityDistribution.critical.count.toString())
      .replace(/{{HIGH_COUNT}}/g, sprintData.priorityDistribution.high.count.toString())
      .replace(/{{MEDIUM_COUNT}}/g, sprintData.priorityDistribution.medium.count.toString())
      .replace(/{{LOW_COUNT}}/g, sprintData.priorityDistribution.low.count.toString());

    return template;
    
  } catch (error) {
    // If template reading fails, create a basic HTML report
    console.log('‚ö†Ô∏è Professional template not found, creating basic HTML report...');
    return createBasicHTMLReport(sprintData);
  }
}

function createBasicHTMLReport(sprintData: any): string {
  return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${sprintData.sprintName} - Release Notes</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { color: #0078d4; margin: 0; font-size: 2.5em; }
        .header p { color: #666; font-size: 1.2em; margin: 10px 0; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
        .metric-card { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #0078d4; }
        .metric-value { font-size: 2em; font-weight: bold; color: #0078d4; }
        .metric-label { color: #666; margin-top: 5px; }
        .section { margin: 30px 0; }
        .section h2 { color: #333; border-bottom: 2px solid #0078d4; padding-bottom: 10px; }
        .work-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .work-item { background: #e3f2fd; padding: 15px; border-radius: 5px; text-align: center; }
        .work-count { font-size: 1.5em; font-weight: bold; color: #1976d2; }
        .work-type { color: #666; margin-top: 5px; }
        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ ${sprintData.sprintName}</h1>
            <p>üìÖ ${new Date(sprintData.startDate).toLocaleDateString()} - ${new Date(sprintData.endDate).toLocaleDateString()}</p>
            <p><strong>Status:</strong> ‚úÖ ${sprintData.status} | <strong>Completion Rate:</strong> ${sprintData.completionRate}%</p>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value">${sprintData.completionRate}%</div>
                <div class="metric-label">Completion Rate</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">${sprintData.storyPoints}</div>
                <div class="metric-label">Story Points</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">${sprintData.completedIssues}</div>
                <div class="metric-label">Issues Completed</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">${sprintData.teamMembers}</div>
                <div class="metric-label">Team Members</div>
            </div>
        </div>

        <div class="section">
            <h2>üìã Work Breakdown</h2>
            <div class="work-breakdown">
                <div class="work-item">
                    <div class="work-count">${sprintData.workBreakdown.stories.count}</div>
                    <div class="work-type">üìö User Stories</div>
                </div>
                <div class="work-item">
                    <div class="work-count">${sprintData.workBreakdown.bugs.count}</div>
                    <div class="work-type">üêõ Bug Fixes</div>
                </div>
                <div class="work-item">
                    <div class="work-count">${sprintData.workBreakdown.tasks.count}</div>
                    <div class="work-type">‚öôÔ∏è Tasks</div>
                </div>
                <div class="work-item">
                    <div class="work-count">${sprintData.workBreakdown.epics.count}</div>
                    <div class="work-type">üéØ Epics</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üéâ Sprint Highlights</h2>
            <ul>
                <li><strong>Exceptional Performance:</strong> ${sprintData.completionRate}% completion rate exceeds target</li>
                <li><strong>High Velocity:</strong> ${sprintData.storyPoints} story points delivered</li>
                <li><strong>Quality Focus:</strong> ${sprintData.workBreakdown.bugs.count} bugs resolved</li>
                <li><strong>Team Collaboration:</strong> ${sprintData.teamMembers} contributors working effectively</li>
                <li><strong>Technical Excellence:</strong> ${sprintData.commitCount} commits with ${sprintData.pipelineBuilds} successful builds</li>
            </ul>
        </div>

        <div class="footer">
            <p>üìÑ Generated on ${new Date().toLocaleString()} | ü§ñ Powered by Release MCP Server</p>
        </div>
    </div>
</body>
</html>`;
}

async function sendTeamsDesignCompliantNotification(sprintData: any, fileName: string) {
  console.log('üì± Sending Teams notification following design guidelines...');
  
  const factory = new MCPToolFactory();
  const teamsNotificationTool = factory.getTool('send_teams_notification');
  
  if (!teamsNotificationTool) {
    throw new Error('Teams notification tool not found');
  }

  try {
    // Main notification following Teams design guidelines
    const mainNotification = `# üéØ **SPRINT SCNT-SPRINT-21 (2025) - COMPLETED**

## üèÜ **EXCEPTIONAL PERFORMANCE ACHIEVED**

---

### üìä **KEY PERFORMANCE METRICS**

**üéØ Sprint Overview:**
- **üìÖ Sprint Period:** July 28 - August 11, 2025
- **‚úÖ Completion Rate:** **${sprintData.completionRate}%** (${sprintData.completedIssues}/${sprintData.totalIssues} issues)
- **‚ö° Velocity:** **${sprintData.storyPoints} Story Points** delivered
- **üë• Team Size:** **${sprintData.teamMembers} contributors** collaborating
- **üèÜ Overall Grade:** **A+ Performance** ü•á

**üíª Technical Delivery:**
- **üìù Code Commits:** ${sprintData.commitCount} commits with full traceability
- **üèóÔ∏è Build Pipelines:** ${sprintData.pipelineBuilds} successful automated builds
- **üîÑ CI/CD Status:** All systems healthy and operational
- **‚ö†Ô∏è Remaining Items:** ${sprintData.remainingIssues} items moved to next sprint

---

### üìã **WORK BREAKDOWN ANALYSIS**

**üìö User Stories:** ${sprintData.workBreakdown.stories.count} items (${sprintData.workBreakdown.stories.percentage}%)
   ‚û§ Feature delivery and user experience enhancements

**üêõ Bug Fixes:** ${sprintData.workBreakdown.bugs.count} items (${sprintData.workBreakdown.bugs.percentage}%)
   ‚û§ System stability and quality improvements

**‚öôÔ∏è Technical Tasks:** ${sprintData.workBreakdown.tasks.count} items (${sprintData.workBreakdown.tasks.percentage}%)
   ‚û§ Infrastructure and operational excellence

**üéØ Epic Components:** ${sprintData.workBreakdown.epics.count} items (${sprintData.workBreakdown.epics.percentage}%)
   ‚û§ Strategic initiative advancement

**üîß Process Improvements:** ${sprintData.workBreakdown.improvements.count} items (${sprintData.workBreakdown.improvements.percentage}%)
   ‚û§ Development efficiency enhancements

---

### ‚ö° **PRIORITY MANAGEMENT EXCELLENCE**

**üî¥ Critical Issues:** ${sprintData.priorityDistribution.critical.count} items ‚Üí **${sprintData.priorityDistribution.critical.resolved} resolved** ‚úÖ

**üü† High Priority:** ${sprintData.priorityDistribution.high.count} items ‚Üí **${sprintData.priorityDistribution.high.resolved} delivered** ‚úÖ

**üü° Medium Priority:** ${sprintData.priorityDistribution.medium.count} items ‚Üí **${sprintData.priorityDistribution.medium.resolved} completed** ‚úÖ

**üü¢ Low Priority:** ${sprintData.priorityDistribution.low.count} items ‚Üí **${sprintData.priorityDistribution.low.resolved} handled** ‚úÖ

**üö´ Blockers:** ${sprintData.priorityDistribution.blockers.count} items ‚Üí **${sprintData.priorityDistribution.blockers.resolved} cleared** ‚úÖ

---

### üéâ **OUTSTANDING ACHIEVEMENTS**

**üåü Performance Highlights:**
   ‚ú® **${sprintData.completionRate}% completion rate** exceeds industry benchmarks
   ü§ù **Exceptional team collaboration** across ${sprintData.teamMembers} contributors  
   üõ°Ô∏è **Quality-first approach** with comprehensive testing
   üìà **Strong development velocity** with ${sprintData.storyPoints} story points
   üîß **Technical excellence** demonstrated in ${sprintData.commitCount} commits

**üèÜ Recognition Deserved:**
This sprint represents outstanding execution and deserves team-wide recognition for exceptional planning, collaboration, and delivery quality.

---

### üìÑ **COMPREHENSIVE DOCUMENTATION**

**‚úÖ Professional Report Generated:** \`${fileName}\`
   üìä Executive summary with strategic insights
   üìà Detailed performance analytics  
   üìã Comprehensive work breakdown
   üéØ Strategic recommendations for next sprint
   üîç Interactive charts and visual indicators

---

**üìÖ Generated:** ${new Date().toLocaleString('en-US', {
      timeZone: 'America/New_York',
      dateStyle: 'full',
      timeStyle: 'short'
    })}

**ü§ñ Powered by:** Release MCP Server - Professional Documentation System`;

    await teamsNotificationTool.execute({
      message: mainNotification,
      title: "üéØ Sprint SCNT-sprint-21 (2025) - Release Complete",
      isImportant: true,
      includeMetadata: true
    });

    console.log('‚úÖ Main Teams notification sent successfully!');

    // Stakeholder access guide
    const stakeholderGuide = `# üë• **STAKEHOLDER ACCESS GUIDE**

## **SCNT-SPRINT-21 RESOURCE NAVIGATION**

---

### üéØ **ROLE-BASED QUICK ACCESS**

**üëî Executive Leadership:**
   üìä **Focus:** ROI analysis, strategic outcomes, ${sprintData.completionRate}% success rate
   üéØ **Key Value:** ${sprintData.storyPoints} story points delivered, A+ performance grade
   üìã **Action:** Review executive summary, consider team recognition
   ‚è±Ô∏è **Time:** 10-15 minutes for complete strategic overview

**üìã Project Management:**
   üìà **Focus:** Resource utilization, ${sprintData.teamMembers} team members, capacity planning
   üéØ **Key Value:** Velocity tracking, ${sprintData.completedIssues} issues completed
   üìã **Action:** Update project plans, optimize next sprint allocation
   ‚è±Ô∏è **Time:** 20-30 minutes for detailed analysis

**üíª Technical Leadership:**
   üîß **Focus:** Code quality, ${sprintData.commitCount} commits, ${sprintData.pipelineBuilds} builds
   üéØ **Key Value:** Build success rates, technical debt management
   üìã **Action:** Review technical recommendations, plan improvements
   ‚è±Ô∏è **Time:** 30-45 minutes for comprehensive technical review

---

### üöÄ **IMMEDIATE NEXT STEPS**

**‚ö° High Priority Actions (This Week):**

**1. üìä Sprint Retrospective**
   ‚û§ Schedule within 48 hours with full team
   ‚û§ Focus on process optimization and lessons learned

**2. üéâ Team Recognition**
   ‚û§ Acknowledge exceptional ${sprintData.completionRate}% performance  
   ‚û§ Consider celebration event for outstanding delivery

**3. üìÖ Next Sprint Planning**
   ‚û§ Include ${sprintData.remainingIssues} remaining items
   ‚û§ Use ${sprintData.storyPoints} SP velocity as baseline

**4. üìà Process Documentation**
   ‚û§ Capture successful methodologies
   ‚û§ Share best practices with other teams

---

### üìû **SUPPORT & CONTACTS**

**üîß Technical Questions:** Development Team Leads (< 2 hours)
**üìä Metrics & Analytics:** Scrum Master (< 4 hours)  
**üéØ Strategic Planning:** Product Owner (< 1 day)
**üìÑ Documentation Access:** DevOps Team (Immediate)

---

**üéä Congratulations to the entire team for this exceptional sprint delivery!**

Professional documentation ready for executive presentation and strategic planning.`;

    await teamsNotificationTool.execute({
      message: stakeholderGuide,
      title: "üë• Stakeholder Guide - SCNT-sprint-21",
      isImportant: false,
      includeMetadata: false
    });

    console.log('‚úÖ Stakeholder guide notification sent successfully!');
    console.log('üé® Teams notifications sent following Microsoft design guidelines');
    console.log('üì± Optimized formatting for Teams display and readability');

  } catch (error) {
    console.error('‚ùå Error sending Teams notification:', error);
    throw error;
  }
}

// Execute the mock sprint generation
generateMockSCNTSprint21()
  .then((result) => {
    console.log('\nüéâ Sprint SCNT-sprint-21 release notes generated successfully!');
    console.log(`üìÑ Professional HTML report: ${result.outputFile}`);
    console.log('üì± Teams notifications sent with design guidelines compliance');
    console.log('‚úÖ Mock sprint data created with realistic metrics');
    console.log('üé® Professional template utilized for executive presentation');
    process.exit(0);
  })
  .catch((error) => {
    console.error('\nüí• Mock sprint generation failed:', error);
    process.exit(1);
  });
